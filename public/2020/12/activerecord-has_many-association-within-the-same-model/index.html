<!doctype html><html><head><meta charset=utf-8><title>brendan tang</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/style.css></head><body><div class=wrapper><header class=site-header><ol class=site-navigation><li><a title="brendan tang" href=https://brendantang.net/>🐒 brendan tang</a></li>▸<li><a title=posts href=https://brendantang.net/posts/>🤔 posts</a></li>▸<li class=active><a title="ActiveRecord has_many Association Within the Same Model" href=https://brendantang.net/2020/12/activerecord-has_many-association-within-the-same-model/>ActiveRecord...</a></li></ol><ul class=site-navigation><li><a title=tags href=/tags>🏷</a></li><li><a title=notebook href=/notebook>📓</a></li><li><a title="my github" href=https://github.com/brendantang>💻</a></li></ul></header><div id=content><article><h1>ActiveRecord has_many Association Within the Same Model</h1><aside><time>published Monday, Dec 14, 2020</time><br><time>last edit Monday, Dec 14, 2020</time></aside><p>In a Rails project I have a data model for <code>recipes</code>.
Some recipes belong to other recipes as byproducts—for example, the recipe for &lsquo;Whey&rsquo; is a byproduct of the recipe for &lsquo;Cheese.&rsquo;</p><p>This calls for some recipe instances to have a <a href=https://guides.rubyonrails.org/association_basics.html#the-has-many-association><code>has_many</code></a> association with their byproduct recipes, which in turn have a <a href=https://guides.rubyonrails.org/association_basics.html#the-belongs-to-association><code>belongs_to</code></a> association back to their parent recipe.</p><p>To achieve this in Rails, the first step is to create a migration adding a column to the <code>recipes</code> table representing that <code>belongs_to</code> relation:</p><pre><code>rails generate migration AddByproductOfRecipeToRecipes
</code></pre><p>Edit the resulting migration file to look like:</p><pre><code>class AddByproductOfRecipeToRecipes &lt; ActiveRecord::Migration[6.0]
  def change
    add_reference :recipes, :byproduct_of
  end
end
</code></pre><p>And run the migration (<code>rails db:migrate</code>).</p><p>Since Rails can&rsquo;t derive the foreign key table from the reference column name <code>byproduct_of_id</code>, the <code>belongs_to</code> and <code>has_many</code> declarations in the Recipe model file need some extra arguments:</p><pre><code>class Recipe &lt; ApplicationRecord
  belongs_to :byproduct_of, optional: true, class_name: 'Recipe'
  has_many :byproducts, class_name: 'Recipe', foreign_key: :byproduct_of
</code></pre><p>See also <a href=https://stackoverflow.com/a/10260455>this stack overflow answer</a>.</p></article><nav class=sidebar><h3>Tags</h3><ul><li><a href=/tags/rails/>rails</a></li><li><a href=/tags/technical-notes/>technical notes</a></li></ul><hr><h3>Adjacent</h3><div><a href=/2020/12/couchdb-is-a-comfortable-way-to-store-unstructured-data/>← CouchDB Is a Comfortable Way to Store Unstructured Data</a><br>- - -<br><a href=/2021/01/advent-of-code-2020-in-haskell/>Advent of Code 2020 in Haskell →</a></div><div><h3>Related</h3><ul><li><a href=/2020/12/stop-rails-server-after-closing-the-terminal/>Stop Rails Server After Closing the Terminal</a></li><li><a href=/2020/10/resolving-sqlexception-ambiguous-column-name-in-a-rails-project/>Resolving SQLException: ambiguous column name in a Rails project</a></li><li><a href=/2020/12/couchdb-is-a-comfortable-way-to-store-unstructured-data/>CouchDB Is a Comfortable Way to Store Unstructured Data</a></li><li><a href=/2020/10/deploying-a-ghost-site-on-dokku/>Deploying a Ghost Site on Dokku</a></li><li><a href=/2020/10/find-and-replace-text-in-all-files-that-contain-it-using-vim-and-grep/>Find and Replace text in all files that contain it using VIM and grep</a></li></ul></div></nav></div><footer style=max-width:100%><a href=/><img style=max-width:100% src=/glasses.svg></a></footer></div></body></html>