<!doctype html><html><head><meta charset=utf-8><title>brendan tang</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/style.css></head><body><div class=wrapper><header class=site-header><a href=/>brendan tang</a><nav class=icon-tags><a title=Posts href=/technical_notes/>POSAT</a>
8
| <a title=tags href=/tags>üè∑</a></nav></header><div id=content><article><h1>ActiveRecord has_many Association Within the Same Model</h1><aside>2020-12-14 11:19:28 -0500 EST</aside><p>In a Rails project I have a data model for <code>recipes</code>.
Some recipes belong to other recipes as byproducts‚Äîfor example, the recipe for &lsquo;Whey&rsquo; is a byproduct of the recipe for &lsquo;Cheese.&rsquo;</p><p>This calls for some recipe instances to have a <a href=https://guides.rubyonrails.org/association_basics.html#the-has-many-association><code>has_many</code></a> association with their byproduct recipes, which in turn have a <a href=https://guides.rubyonrails.org/association_basics.html#the-belongs-to-association><code>belongs_to</code></a> association back to their parent recipe.</p><p>To achieve this in Rails, the first step is to create a migration adding a column to the <code>recipes</code> table representing that <code>belongs_to</code> relation:</p><pre><code>rails generate migration AddByproductOfRecipeToRecipes
</code></pre><p>Edit the resulting migration file to look like:</p><pre><code>class AddByproductOfRecipeToRecipes &lt; ActiveRecord::Migration[6.0]
  def change
    add_reference :recipes, :byproduct_of
  end
end
</code></pre><p>And run the migration (<code>rails db:migrate</code>).</p><p>Since Rails can&rsquo;t derive the foreign key table from the reference column name <code>byproduct_of_id</code>, the <code>belongs_to</code> and <code>has_many</code> declarations in the Recipe model file need some extra arguments:</p><pre><code>class Recipe &lt; ApplicationRecord
  belongs_to :byproduct_of, optional: true, class_name: 'Recipe'
  has_many :byproducts, class_name: 'Recipe', foreign_key: :byproduct_of
</code></pre><p>See also <a href=https://stackoverflow.com/a/10260455>this stack overflow answer</a>.</p></article><nav class=sidebar><h3>Tags</h3><ul><li><a href=/tags/rails/>rails</a></li><li>üíª <a href=/tags/technical-notes/>technical notes</a></li></ul><hr><h3>Adjacent</h3><div><a href=/technical_notes/couchdb_is_a_comfortable_way_to_store_unstructured_data/>‚Üê CouchDB Is a Comfortable Way to Store Unstructured Data</a><br>- - -<br><a href=/technical_notes/advent_of_code_2020_in_haskell/>Advent of Code 2020 in Haskell ‚Üí</a></div><div><h3>Related</h3><ul><li><a href=/technical_notes/stop_rails_server_after_closing_the_terminal/>Stop Rails Server After Closing the Terminal</a></li><li><a href=/technical_notes/resolving_sql_exception_ambiguous_column_name_in_rails/>Resolving SQLException: ambiguous column name in a Rails project</a></li><li><a href=/technical_notes/couchdb_is_a_comfortable_way_to_store_unstructured_data/>CouchDB Is a Comfortable Way to Store Unstructured Data</a></li><li><a href=/technical_notes/deploying_a_ghost_site_on_dokku/>Deploying a Ghost Site on Dokku</a></li><li><a href=/technical_notes/find_and_replace_text_in_all_files_vim_grep/>Find and Replace text in all files that contain it using VIM and grep</a></li></ul></div></nav></div><footer style=max-width:100%><a href=/><img style=max-width:100% src=/glasses.svg></a></footer></div></body></html>